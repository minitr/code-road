<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | TS&#39;s code-road </title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/code-road/img/web.png">
    <meta name="description" content="TS的编程之路">
    
    <link rel="preload" href="/code-road/assets/css/0.styles.e7462a0f.css" as="style"><link rel="preload" href="/code-road/assets/js/app.4d1c255e.js" as="script"><link rel="preload" href="/code-road/assets/js/2.adebb15e.js" as="script"><link rel="preload" href="/code-road/assets/js/4.a620297f.js" as="script"><link rel="prefetch" href="/code-road/assets/js/10.528e2c69.js"><link rel="prefetch" href="/code-road/assets/js/11.c0f4b136.js"><link rel="prefetch" href="/code-road/assets/js/12.0c73fc86.js"><link rel="prefetch" href="/code-road/assets/js/13.7711cafd.js"><link rel="prefetch" href="/code-road/assets/js/14.20c40d60.js"><link rel="prefetch" href="/code-road/assets/js/15.75cf58d2.js"><link rel="prefetch" href="/code-road/assets/js/16.f81df16b.js"><link rel="prefetch" href="/code-road/assets/js/17.8bede11e.js"><link rel="prefetch" href="/code-road/assets/js/18.0c60bac9.js"><link rel="prefetch" href="/code-road/assets/js/19.a20d3a5b.js"><link rel="prefetch" href="/code-road/assets/js/20.59b88eb4.js"><link rel="prefetch" href="/code-road/assets/js/3.59401401.js"><link rel="prefetch" href="/code-road/assets/js/5.f1dc2d74.js"><link rel="prefetch" href="/code-road/assets/js/6.d0bbc0ba.js"><link rel="prefetch" href="/code-road/assets/js/7.e05e0ac8.js"><link rel="prefetch" href="/code-road/assets/js/8.6407e9ef.js"><link rel="prefetch" href="/code-road/assets/js/9.56e8587b.js">
    <link rel="stylesheet" href="/code-road/assets/css/0.styles.e7462a0f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/code-road/" class="home-link router-link-active"><!----> <span class="site-name">TS's code-road </span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/code-road/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-road/Java/RabbitMQ.html" class="nav-link">消息队列</a></li><li class="dropdown-item"><!----> <a href="/code-road/Java/Redis.html" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><a href="/code-road/pages/558004/404" class="nav-link">AI</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法题解" class="dropdown-title"><!----> <span class="title" style="display:;">算法题解</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-road/算法题解/简介.html" class="nav-link">简介</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TS的小窝" class="dropdown-title"><!----> <span class="title" style="display:;">TS的小窝</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/MinitR" target="_blank" rel="noopener noreferrer" class="nav-link external">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/code-road/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><!----> <span class="title" style="display:;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-road/Java/RabbitMQ.html" class="nav-link">消息队列</a></li><li class="dropdown-item"><!----> <a href="/code-road/Java/Redis.html" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><a href="/code-road/pages/558004/404" class="nav-link">AI</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法题解" class="dropdown-title"><!----> <span class="title" style="display:;">算法题解</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/code-road/算法题解/简介.html" class="nav-link">简介</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="TS的小窝" class="dropdown-title"><!----> <span class="title" style="display:;">TS的小窝</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/MinitR" target="_blank" rel="noopener noreferrer" class="nav-link external">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/code-road/about/简介" class="sidebar-heading clickable"><span>关于本站</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/code-road/pages/5a251b/" class="sidebar-link">简介</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/code-road/Java/Java路线" class="sidebar-heading clickable open"><span>Java</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/code-road/pages/558004/" aria-current="page" class="active sidebar-link">RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#应用" class="sidebar-link">应用</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#分类" class="sidebar-link">分类</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#核心部分" class="sidebar-link">核心部分</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#安装以及java环境" class="sidebar-link">安装以及Java环境</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#工作队列" class="sidebar-link">工作队列</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#交换机" class="sidebar-link">交换机</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#死信队列" class="sidebar-link">死信队列</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#延迟队列" class="sidebar-link">延迟队列</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#发布确认-2" class="sidebar-link">发布确认</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#其他问题" class="sidebar-link">其他问题</a></li><li class="sidebar-sub-header level2"><a href="/code-road/pages/558004/#rabbitmq集群" class="sidebar-link">RabbitMQ集群</a></li></ul></li><li><a href="/code-road/pages/1c1c9c/" class="sidebar-link">Redis</a></li><li><a href="/code-road/pages/2583bb/" class="sidebar-link">Java源码和新特性</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/code-road/AI/简介" class="sidebar-heading clickable"><span>AI</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/code-road/算法题解/简介" class="sidebar-heading clickable"><span>算法题解</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/code-road/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/code-road/categories/?category=Java" title="分类" data-v-06225672>Java</a></li></ul> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-07-31</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">RabbitMQ<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="rabbitmq"><a href="#rabbitmq" class="header-anchor">#</a> RabbitMQ</h1> <p>本篇内容源自尚硅谷<a href="https://www.bilibili.com/video/BV1cb4y1o7zz?spm_id_from=333.337.search-card.all.click&amp;vd_source=37a99503a892f833b7067996ce46f54e" target="_blank" rel="noopener noreferrer">RabbitMQ课程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>通过服务管理可以查看本机进程</p> <p>消息队列是用于传输和保存消息的容器，也是大型分布式系统中常用的技术，主要解决应用耦合、异步消息、流量削锋等问题。</p> <p>本质上是个队列，只不过存放的内容是message</p></blockquote> <h2 id="应用"><a href="#应用" class="header-anchor">#</a> 应用</h2> <h3 id="流量消峰"><a href="#流量消峰" class="header-anchor">#</a> 流量消峰</h3> <p>通过消息队列进行缓冲处理，减少系统宕机概率</p> <p><img src="/code-road/assets/img/image-20220608193252172.8d2b6590.png" alt="image-20220608193252172"></p> <h3 id="应用解耦"><a href="#应用解耦" class="header-anchor">#</a> 应用解耦</h3> <p>队列存放子系统内存，解耦应用</p> <h3 id="异步处理"><a href="#异步处理" class="header-anchor">#</a> 异步处理</h3> <p><img src="/code-road/assets/img/image-20220608193626400.31778f31.png" alt="image-20220608193626400"></p> <h2 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h2> <ul><li><p>Kafka</p> <p>大数据业务、日志采集</p></li> <li><p>RocketMQ</p> <p>金融互联网，可靠性高</p></li> <li><p>RabbitMQ</p> <p>界面方便，数据量没有那么大</p></li></ul> <h2 id="核心部分"><a href="#核心部分" class="header-anchor">#</a> 核心部分</h2> <p>接受并转发消息，不进行处理，只是接收存储和转发</p> <h3 id="四大核心概念"><a href="#四大核心概念" class="header-anchor">#</a> 四大核心概念</h3> <ul><li>生产者，（厂家）</li> <li>MQ
<ul><li>交换机（快递员）</li> <li>队列，一个交换机可以绑定多个队列（快递站）</li></ul></li> <li>消费者，一个队列对应一个消费者（收件人）</li></ul> <h2 id="安装以及java环境"><a href="#安装以及java环境" class="header-anchor">#</a> 安装以及Java环境</h2> <p>安装教程 https://blog.csdn.net/www_xuhss_com/article/details/125176614，以及官网</p> <h3 id="java环境"><a href="#java环境" class="header-anchor">#</a> Java环境</h3> <p>导入依赖</p> <p>RabbitMQ Java 客户端使用<code>com.rabbitmq.client</code>作为它的顶级包。关键的类和接口有：</p> <ul><li>Channel: 代表 AMQP 0-9-1通道，并提供了大多数操作（协议方法）。</li> <li>Connection: 代表 AMQP 0-9-1 连接</li> <li>ConnectionFactory: 构建<code>Connection</code>实例</li> <li>Consumer: 代表消息的消费者</li> <li>DefaultConsumer: 消费者通用的基类</li> <li>BasicProperties: 消息的属性（元信息）</li> <li>BasicProperties.Builder: <code>BasicProperties</code>的构建器</li></ul> <p>通过<code>Channel</code>（通道）的接口可以对协议进行操作。<code>Connection</code>（连接）用于开启通道，注册连接的生命周期内的处理事件，并且关闭不再需要的连接。<code>ConnectionFactory</code>用于实例化<code>Connection</code>对象，并且可以通过<code>ConnectionFactory</code>来进行诸如vhost、username等属性的设置</p> <p>http://rabbitmq.mr-ping.com/ClientDocumentation/java-api-guide.html</p> <h4 id="连接和信道"><a href="#连接和信道" class="header-anchor">#</a> 连接和信道</h4> <p>核心的接口类为<code>Connection</code>和<code>Channel</code>，分别代表AMQP 0-9-1的连接和通道。通常在使用之前将他们引入：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Connection</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Channel</span></span><span class="token punctuation">;</span>
</code></pre></div><h4 id="连接到rabbitmq"><a href="#连接到rabbitmq" class="header-anchor">#</a> 连接到RabbitMQ</h4> <p>以下代码演示使用给定的参数（如主机名、端口号）连接到RabbitMQ节点：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &quot;guest&quot;/&quot;guest&quot; by default, limited to localhost connections</span>
factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
factory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span>virtualHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span>hostName<span class="token punctuation">)</span><span class="token punctuation">;</span>
factory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>portNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Connection</span> conn <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来，<code>Connection</code>接口就可以用来开启通道(Channel)了：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Channel</span> channel <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="声明队列"><a href="#声明队列" class="header-anchor">#</a> 声明队列</h4> <p>客户端使用用利用交换机和<a href="https://www.rabbitmq.com/queues.html" target="_blank" rel="noopener noreferrer">队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这些高级的<a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html" target="_blank" rel="noopener noreferrer">协议构建块工作<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。在使用事前必须对他们进行声明</p> <p>接着上边的例子，以下代码声明了一个交换机以及一个<a href="https://www.rabbitmq.com/queues.html#server-named-queues" target="_blank" rel="noopener noreferrer">服务端命名的队列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，然后将它们绑定到一起。</p> <div class="language-java extra-class"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> queueName <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> exchangeName<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="/code-road/assets/img/image-20220706163956154.f324da43.png" alt="image-20220706163956154"></p> <h4 id="发布消息"><a href="#发布消息" class="header-anchor">#</a> 发布消息</h4> <p><img src="/code-road/assets/img/image-20220706164000986.dc4bd1eb.png" alt="image-20220706164000986"></p> <p>只能发送二进制</p> <p>完整的生产者代码</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.112&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Connection</span> conn <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Channel</span> channel <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;hello world&quot;</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> QUEUE_NAME<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="消费者接收信息"><a href="#消费者接收信息" class="header-anchor">#</a> 消费者接收信息</h4> <p>实现<code>Consumer</code>最简单的方式是子类化<code>DefaultConsumer</code>。此子类的实例化对象可以当做<code>basicConsume</code>调用时的参数进行传递，用于设置订阅：</p> <p>autoAck表示是否自动应答，第三个参数表示消费者正常消费的回调，最后一个表示取消消费的回调</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">boolean</span> autoAck <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queueName<span class="token punctuation">,</span> autoAck<span class="token punctuation">,</span> <span class="token string">&quot;myConsumerTag&quot;</span><span class="token punctuation">,</span>
     <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span><span class="token class-name">String</span> consumerTag<span class="token punctuation">,</span>
                                    <span class="token class-name">Envelope</span> envelope<span class="token punctuation">,</span>
                                    <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span> properties<span class="token punctuation">,</span>
                                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span>
             <span class="token keyword">throws</span> <span class="token class-name">IOException</span>
         <span class="token punctuation">{</span>
             <span class="token class-name">String</span> routingKey <span class="token operator">=</span> envelope<span class="token punctuation">.</span><span class="token function">getRoutingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token class-name">String</span> contentType <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">// (process the message components here ...)</span>
             channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里由于我们设置了<code>autoAck = false</code>，需要手动对投递到<code>Consumer</code>的消息进行确认。最简便的方式就是如上边介绍的一样在<code>handleDelivery</code>中进行。</p> <div class="language-Java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConnectionFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">&quot;192.168.0.112&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Connection</span> conn <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DeliverCallback</span> deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">CancelCallback</span> cancelCallback<span class="token operator">=</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;被中断开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//第三个参数为正常接收消息，第四个为消息接收异常</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>deliverCallback<span class="token punctuation">,</span>cancelCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="关闭mq连接"><a href="#关闭mq连接" class="header-anchor">#</a> 关闭MQ连接</h4> <p>通过简单的对通道和连接进行关闭即可关闭掉RabbitMQ的连接：</p> <div class="language-java extra-class"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>需要注意的是，虽然将通道关闭掉是最佳实践，但并不是必须的操作。因为无论何种情况，通道都会在底层的连接关闭时自动关闭掉。</p> <h2 id="工作队列"><a href="#工作队列" class="header-anchor">#</a> 工作队列</h2> <p><img src="/code-road/assets/img/image-20220608213137027.8e1ba831.png" alt="image-20220608213137027"></p> <p>当生产者大量发送消息时，一个消息只能被处理一次，不能被处理多次，采用轮询分发消息</p> <h3 id="消息应答"><a href="#消息应答" class="header-anchor">#</a> 消息应答</h3> <p>MQ一旦发送后就会把消息删除，如果消费者还未处理消息就挂了，将丢失消息，所以需要消费者应答，应答后mq再删除消息，消息应答分为两种</p> <ul><li><p>自动应答</p> <p>尽量少使用</p></li> <li><p>手动应答</p> <p><img src="/code-road/assets/img/image-20220621194227558.0ae80f86.png" alt="image-20220621194227558"></p></li></ul> <p>批量应答：是否将信道内的消息全部应答</p> <p>如果消息丢失，则会消息重新入队，并重新发配给可处理的消费者</p> <h4 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h4> <p>生产者大量发送消息：</p> <div class="language-Java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">&quot;ack_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Scanner</span> scanner<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span> message<span class="token operator">=</span>scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> QUEUE_NAME<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;生产者消息：&quot;</span><span class="token operator">+</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>消费者手动应答，两个消费者，一个C2时间长，一个C1时间短</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_NAME <span class="token operator">=</span> <span class="token string">&quot;ack_queue&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者2花费较长&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DeliverCallback</span> deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">SleepUtils</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到的消息&quot;</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">CancelCallback</span> cancelCallback<span class="token operator">=</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;被中断开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>deliverCallback<span class="token punctuation">,</span>cancelCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>发送消息aa和bb</p> <p>正常情况下应该由C1，C2轮流接受消息，但是如果在C2处理期间停掉C2，那么消息将转发给C1！</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASMAAABCCAIAAACTnScxAAAGTklEQVR4nO3cX2xTVRwH8N9tFzMHcYZ1c2ya/Wm3QRYjUUmMGomCZEYSHwAV9QnCg4mJJSFKgolPCkpiGkxMfFESTVDU+LIgQ4waIw41hDlCnGMdjCltV0AmuFlZjw+Q5u6c8zv3tBcPD/1+Hkh3eu65p6S/nj/33p/X29tLAPA/i9zoDgBUBUQagAuINAAXEGkALgRHWiqVCnzXXMemHcsDQ3bGpqmK+wlgUCP9nUqlksmk/4X2LancXygdpeVvXIhI0/KnN61fflvhyDuv7B31PH+zhtchO5NMJtXPqDalHmX6YAAMT93ll4LN/696vPSuVI0bH3xhVhvv27zx4brjR6fvuvPCe75IU/ujtm/fGX9PrtbhulTWTwaAJU2kSbRfbsMUi/uCaiNWiObVG1dNf/HxYP3a15+jPbpIC2TZGXOUajsptYzYg4rNmz1yg4D2Z14d96Sm1QDQTe2yh/Z8IIRH9WwXDRNa+85oP6BaWT1Q+x8CUK55kSZ989R1mvZPdR/i6oE244nnCSFMgxgXw1zfuM6U4kpqIXC1BnBdyDsiNqssmv/1JX4wJCUGtCfiaDugBoZlZ/xBKK0/1ekiN4EEqIwcaX6GMU2NH26uqLajraySRiF/IdeaoTPm+ac0jPtHvMB+AtjQRJrlz7l2P1CdfKZSqcqGBXNIlNuZkrLmivbbngBm7PU0Clqn2TOMQkJEb2lqXBAlaqiNeLRo8eJmKvx59tysbq+f66cNdYA1bOSU3gq8yAFgid17NPMPev45HnfNjW+pccWml1c1X4urDduWCXFi79Z3f5yTW9BeBLPvjDpKW4YQppFwXch7j1w986a/tAOh3bHQtuZ5mf6dW/rls8kDmn+fkGvKsjNSealNdYWmDWyEHFQm+Mo1AISHe/kBXECkAbiASANwAZEG4AIiDcAFRBqAC4g0ABcQaQAuINIAXNBEmvbGKy3DUyqBuMfYymrQsnsAN5zp+TRibni3vBHZ/r5B+wa5x8wC8zKoZxc1927e8Wxv/uCOnftzvkcHuHKAMNhIC8wjEsgmKkqNq6cwPOcixT/3FLbhExERxePt5zOZxnjXAsr9bVEOEIL81EzpReC3WaKm7iBlqLF5jlM9SlvTnGbHZt7YGm8X498dLTwR74p+P1QMLAcIQ/PUjJrNxhxmXDhJgxXZzRK5OoHzQ3PsSUcJsaA7Hjs1+NPJ2ZUPJNppKG0uBwgpePYoJbpRq3GhqIafzVDDzTmTFeXtYtV0d94+mR4pnJ45VdvX1SDGzl1dknHlAOHoI81+3ljByk17OrWmefVlmeOEPUtnouNi+sBFmhsbm2he1lNHh2eM5QDh6Ndp0hPH2hma9vFnroJ5T4VblRmEHNMWJzoXNsRefPNBIi8aEdOJ6OHhoqEcICT9Oo2UWZwaRVLGDsMQVFm6G/NqzRBLaj+lCkLUdceb0gOpfUMFImpb/UJfoo2Gx7nycnsOoDLdI2L5baagjDrmY+1J6zQ/qRr5fi80l9drujrvOJ8+MZHNZrPZ7C+jZ+o7EouEYMsBQgvOrKruhXDXxwy7lCGSZ8lnKZd/TL7WSFuiQ0z8/Pu1CjPjp3PrEt03H/yhRV8+OFvBaQHm0eR7lF5w8VaqJgWhOsELvN5l2L7nNhu51gKTWxGRl/7s1W1UysDlZQfe2EpEHlfOnRfAHnJjAbiAe/kBXECkAbiASANwAZEG4AIiDcAFRBqAC4g0ABcQaQAuINIAXEBuLAAXqjE3lhCxvpe2P9bqCTFXuHxh8viXn+wbzBQ9rjywYwCBqjc31sn+nR8dK9Y2LO3b8OQzj6TfOjRlLgcIo3pzYxUu5fP5K5TPfXXsoedbWommzOUAYVRpbqySaP2Su3sWTh45Y1kOUJlqzY1FtGT9jl1rI9Ea7/Jvn+/+Nl96Do0rBwijWnNjEaUPvP3pcLE21v3oujUbVozs/iZnLgcIo0pzYxFR4a8/MpkrlJn88Nae1+6/p/Hr/TmmfAopHyG0asyNJfn3n0IxEolalwNUoCpzYxER0U0LY7FYY0vivqdWLr00NjoVVA4QRlXmxiIiosSabdsfL87NTJ/9tf/9/pE5zyPBlAOEVpW5sbz8wK4tA/PLDOUA4SE3FoALuJcfwAVEGoALiDQAFxBpAC78B5cILzLokrrKAAAAAElFTkSuQmCC" alt="image-20220621202247743"></p> <h3 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h3> <h4 id="队列持久化"><a href="#队列持久化" class="header-anchor">#</a> 队列持久化</h4> <p>如果RabbitMQ宕机，队列就消失了，所以有需要的时候要进行持久化操作，如果队列已存在，需要先删除再创建</p> <h4 id="消息持久化"><a href="#消息持久化" class="header-anchor">#</a> 消息持久化</h4> <p>保证消息不丢失，需要修改生产者代码，发布消息的时候进行持久化</p> <h3 id="不公平分发"><a href="#不公平分发" class="header-anchor">#</a> 不公平分发</h3> <p>为了避免处理速度慢的消费者拖慢进度，可以设置不公平分发，更改在消费者处</p> <div class="language-java extra-class"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="预取值"><a href="#预取值" class="header-anchor">#</a> 预取值</h3> <p>prefetch=xx，xx为分发的条数，设置给信道</p> <div class="language-java extra-class"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span>prefetch<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="发布确认"><a href="#发布确认" class="header-anchor">#</a> 发布确认</h3> <p><img src="/code-road/assets/img/image-20220621211550137.9043b277.png" alt="image-20220621211550137"></p> <p>队列需要向生产者发布确认，磁盘持久化</p> <ul><li><p>单个发布确认</p> <p>同步确认方式，发布速度很慢</p> <p><img src="/code-road/assets/img/image-20220621212401764.b659e047.png" alt="image-20220621212401764"></p></li> <li><p>批量发布确认</p> <p>数量达到一定数目确认</p></li> <li><p>异步确认发布，性能和时间上都是最好的！</p> <p>由broker监听器来监听消息发布的成功与否</p> <p><img src="/code-road/assets/img/image-20220623190718233.114c7125.png" alt="image-20220623190718233"></p> <p>未发送成功的消息可以存储以便之后处理，可以放在一个基于内存的能被发布线程访问的队列</p> <p><img src="/code-road/assets/img/image-20220623191307641.a520d285.png" alt="image-20220623191307641"></p></li></ul> <h2 id="交换机"><a href="#交换机" class="header-anchor">#</a> 交换机</h2> <p><img src="/code-road/assets/img/image-20220623192706678.bf383484.png" alt="image-20220623192706678"></p> <p>达到一个消息能被消费两次的效果，但是注意，一个队列中的消息仍然只能被消费一次</p> <h3 id="类型"><a href="#类型" class="header-anchor">#</a> 类型</h3> <ul><li><p>直接类型：根据key值发送，一个队列和一个交换机之间可以有多个key值，只能路由一个队列</p></li> <li><p>主题类型：为了解决直接类型的问题，主题单词的routing_key不能随便写，必须是一个单词列表，以点号分割开 *代表一个单词，#代表0或者多个单词</p> <p><em>.</em>.rabbit 中间有两个星号，打不出来，代表三个单词以rabbit结尾，消费者键为这样的模式串，发送方的键为确定的值</p></li> <li><p>扇出类型：类似广播，只要队列绑定，就会发送，无视key</p></li> <li><p>无名类型：默认交换机</p></li></ul> <h2 id="死信队列"><a href="#死信队列" class="header-anchor">#</a> 死信队列</h2> <p>死信队列用于处理无法被正常消费的消息，即死信消息。如何查询、导出和重新发送进入死信队列的死信消息，以便按需管理死信消息，避免消息漏处理。</p> <h3 id="背景信息"><a href="#背景信息" class="header-anchor">#</a> 背景信息</h3> <p>当一条消息初次消费失败，消息队列MQ会自动进行消息重试，达到最大重试次数后，若消费依然失败，则表明消费者在正常情况下无法正确地消费该消息。此时，消息队列MQ不会立刻将消息丢弃，而是将其发送到该消费者对应的特殊队列中。</p> <p>产生的三种情况</p> <ul><li>消息过期</li> <li>消息超过队列长度</li> <li>消息被拒绝</li></ul> <p>在消息队列MQ版中，这种正常情况下无法被消费的消息称为死信消息（Dead-Letter Message），存储死信消息的特殊队列称为死信队列（Dead-Letter Queue）。</p> <h3 id="设置"><a href="#设置" class="header-anchor">#</a> 设置</h3> <p>普通队列绑定死信交换机，可以把信息转发给死信交换机，设置argument：一个Map，通过固定的key值进行配置，将普通队列绑定死信交换机，再设置routingKey，将死信交换机和死信队列绑定</p> <h2 id="延迟队列"><a href="#延迟队列" class="header-anchor">#</a> 延迟队列</h2> <p>存放需要在指定时间被处理的元素的队列，可能是在指定时间之前或者之后处理</p> <p>例如订单下单成功需要在十分钟内付款，否则自动取消</p> <p><strong>整合Springboot</strong></p> <p>引入依赖和swagger</p> <p><img src="/code-road/assets/img/image-20220704150826813.d101dde3.png" alt="image-20220704150826813"></p> <p>需求架构图，XY为交换机 QA和QB为两个不同延时的队列，QD为死信队列</p> <p>通过配置类声明队列和交换机，并进行绑定</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TtlQueueConfig</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> X_EXCHANGE <span class="token operator">=</span> <span class="token string">&quot;X&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> Y_DEAD_LETTER_EXCHANGE <span class="token operator">=</span> <span class="token string">&quot;Y&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_A <span class="token operator">=</span> <span class="token string">&quot;QA&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> QUEUE_B <span class="token operator">=</span> <span class="token string">&quot;QB&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DEAD_LETTER_QUEUE <span class="token operator">=</span> <span class="token string">&quot;QD&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;xExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">xExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span>X_EXCHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;yExchange&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">yExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span>Y_DEAD_LETTER_EXCHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;QAQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token class-name">QAQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> argument <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> Y_DEAD_LETTER_EXCHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;YD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span>QUEUE_A<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withArguments</span><span class="token punctuation">(</span>argument<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;QBQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token class-name">QBQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> argument <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> Y_DEAD_LETTER_EXCHANGE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;YD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argument<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">40000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span>QUEUE_B<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withArguments</span><span class="token punctuation">(</span>argument<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;QDQueue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token class-name">QDQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">QueueBuilder</span><span class="token punctuation">.</span><span class="token function">durable</span><span class="token punctuation">(</span>DEAD_LETTER_QUEUE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token comment">//绑定</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token class-name">QABinding</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;QAQueue&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;xExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;XA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token class-name">QBBinding</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;QBQueue&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;xExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;XB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token class-name">QDBinding</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;QDQueue&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Queue</span> queue<span class="token punctuation">,</span> <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;yExchange&quot;</span><span class="token punctuation">)</span> <span class="token class-name">DirectExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">&quot;YD&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过get请求发送消息</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/ttl&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageSendController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test/{message}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前时间{}发送给两个队列的信息{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XA&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;消息来自10s的队列&quot;</span><span class="token operator">+</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;X&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;XB&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;消息来自40s的队列&quot;</span><span class="token operator">+</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>通过监听器接收消息</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token comment">//通过监听进行消息消费</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span>  <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
    <span class="token comment">//接收消息</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;QD&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前时间为{}接收到消息{}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>运行结果如下</p> <p><img src="/code-road/assets/img/image-20220706170423991.22cd0a9b.png" alt="image-20220706170423991"></p> <p>第一条消息在10s后变成了死信消息，然后被消费者消费，第二条消息在40s后变成了死信消息，然后被消费掉</p> <p>相当于巧妙的利用了死信队列的特点，消息在10s内都未被接收，就进入了死信队列然后才会被消费者消费，太妙了</p> <h3 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h3> <p>如果还要新增新的时间情况，那就得新增新的队列，这会导致非常耦合，需要进行优化</p> <p>通过一个不设置过期时间的QC队列，通过生产者来确定时间需求</p> <p>生产者代码</p> <p><img src="/code-road/assets/img/image-20220704161754634.b679675b.png" alt="image-20220704161754634"></p> <p>但这样也是有问题的，会导致消息堆积</p> <p>比如说我先发送一个需要延迟20s的消息，再发送一个需要延迟2s的消息</p> <p>因为20s先进队列，由于队列的特性，会导致本应该只被积压2s的消息需要在20s消息被消费后再消费！</p> <h3 id="如何解决上述问题-插件"><a href="#如何解决上述问题-插件" class="header-anchor">#</a> 如何解决上述问题--插件</h3> <p>插件解决</p> <p>首先安装延迟队列插件，是基于交换机来延迟，这种新定义的交换机CustomExchange，是一种新的交换类型，消息投递后不会立即到目标队列中，而是存储在mnesia（一个分布式数据系统）表中，当达到投递时间，才放到队列中</p> <p><img src="/code-road/assets/img/image-20220704163845651.d60fd058.png" alt="image-20220704163845651"></p> <h2 id="发布确认-2"><a href="#发布确认-2" class="header-anchor">#</a> 发布确认</h2> <h3 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h3> <p>生产者发消息给交换机-&gt;队列，交换机/队列宕机的情况下通过缓存恢复数据</p> <h3 id="回调接口-交换机收不到消息"><a href="#回调接口-交换机收不到消息" class="header-anchor">#</a> 回调接口（交换机收不到消息）</h3> <p>通过生产者发消息的时候编写回调接口，如果交换机没有回应，就会触发回调接口</p> <ul><li><p>编写confirm类继承RabbitMQ.ConfirmCallBack</p> <p><img src="/code-road/assets/img/image-20220705235239969.dc28c62a.png" alt="image-20220705235239969"></p> <p>并将这个类当前接口注入到RabbitMQTemplate内</p> <p>同时，需要在配置文件中进行配置</p> <p><img src="/code-road/assets/img/image-20220705235720238.573b0810.png" alt="image-20220705235720238"></p></li></ul> <h3 id="回退消息-队列没有收到消息、routingkey问题"><a href="#回退消息-队列没有收到消息、routingkey问题" class="header-anchor">#</a> 回退消息（队列没有收到消息、routingKey问题）</h3> <p>此时生产者已经收到交换机的确认，而队列收不到消息，会导致消息被丢弃</p> <p><strong>解决方法</strong>：通过设置mandatory参数可以使消息在不可达目的地的时候将消息返回给生产者</p> <h3 id="备份交换机"><a href="#备份交换机" class="header-anchor">#</a> 备份交换机</h3> <p>队列没有收到消息时，交换机会将消息转发给备份交换机，再转发给报警队列和备份队列以供消费者使用，且备份交换机级别比mandatory参数高</p> <h2 id="其他问题"><a href="#其他问题" class="header-anchor">#</a> 其他问题</h2> <h3 id="幂等性问题"><a href="#幂等性问题" class="header-anchor">#</a> 幂等性问题</h3> <p>简单来说，就是重复提交，消费者重复消费</p> <p><img src="/code-road/assets/img/image-20220706153358215.e80e3661.png" alt="image-20220706153358215"></p> <p>一般通过uuid或者时间戳生成id，通过判断id判断是否消费过消息</p> <p>或者redis原子性进行解决</p> <h3 id="优先级队列"><a href="#优先级队列" class="header-anchor">#</a> 优先级队列</h3> <p>通过设置优先级队列达到优先级越高的消息排在越前面</p> <h3 id="惰性队列"><a href="#惰性队列" class="header-anchor">#</a> 惰性队列</h3> <p>正常情况：消息是保存在内存</p> <p>惰性队列：消息保存在磁盘中，速度较慢</p> <h2 id="rabbitmq集群"><a href="#rabbitmq集群" class="header-anchor">#</a> RabbitMQ集群</h2> <p>搭建集群</p> <ul><li><p>更改host文件主机名，设置三个虚拟节点node1、node2、node3</p></li> <li><p>将主机的erlang的cookie复制给从机</p> <p><img src="/code-road/assets/img/image-20220706160339579.f35370e0.png" alt="image-20220706160339579"></p></li> <li><p>需要搞清楚的是，在哪个机器上创建的队列就属于哪个机器，而不是每个机器上都有，并且这个队列属于整个集群，这就涉及到消息有可能丢失，需要设置镜像队列</p> <p><img src="/code-road/assets/img/image-20220706161124222.7484931a.png" alt="image-20220706161124222"></p> <p>pattern的意思是正则表达式，意味着队列名必须以mirror开头</p></li></ul></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/code-road/pages/5a251b/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">简介</div></a> <a href="/code-road/pages/1c1c9c/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Redis</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
          ←
          <a href="/code-road/pages/5a251b/" class="prev">简介</a></span> <span class="next"><a href="/code-road/pages/1c1c9c/">Redis</a>→
        </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/code-road/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/code-road/pages/7d50da/"><div>
              2022-8月题解
              <!----></div></a> <span class="date">08-01</span></dt></dl><dl><dd>02</dd> <dt><a href="/code-road/pages/3714b6/"><div>
              简介
              <!----></div></a> <span class="date">07-31</span></dt></dl><dl><dd>03</dd> <dt><a href="/code-road/pages/4943b4/"><div>
              2022-7月题解
              <!----></div></a> <span class="date">07-31</span></dt></dl> <dl><dd></dd> <dt><a href="/code-road/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
    Theme by
    <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
            跟随系统
          </li><li class="iconfont icon-rijianmoshi">
            浅色模式
          </li><li class="iconfont icon-yejianmoshi">
            深色模式
          </li><li class="iconfont icon-yuedu">
            阅读模式
          </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/code-road/assets/js/app.4d1c255e.js" defer></script><script src="/code-road/assets/js/2.adebb15e.js" defer></script><script src="/code-road/assets/js/4.a620297f.js" defer></script>
  </body>
</html>
